{"ts":1360341414459,"silentsave":true,"restoring":false,"patch":[[]],"length":0}
{"contributors":[],"silentsave":false,"ts":1360341422067,"patch":[[{"diffs":[[1,"var m = L.map('map').setView([42.35904337942925, -71.06178045272827], 18)\nvar baseMaps = [\n    \"MapQuestOpen.OSM\",\n    \"OpenStreetMap.Mapnik\",\n    \"OpenStreetMap.DE\",\n    \"Esri.WorldImagery\",\n    \"Stamen.TerrainBackground\",\n    \"Stamen.Watercolor\",\n];\n\n//var bikes = L.geoJson.ajax(\"bikes.json\",{onEachFeature: onEachFeature,style:style});\n\nL.control.layers.filled(baseMaps,{},{map:m})\nfunction getUrl(){\n    return \"bikes.json\";//http://calvin.iriscouch.com/bike/_design/bike/_spatiallist/geojson/all?bbox=-77.0196533203125,40.52215098562377,-66.8133544921875,43.55651037504758\";\n}\nvar docs=L.geoJson(undefined,{onEachFeature: onEachFeature,style:style});\nvar boxes = L.featureGroup([]);\nfunction onEachFeature(feature, layer) {\n    // does this feature have a property named popupContent?\n    if (feature.properties) {\n    \tvar out = [];\n        for(var key in feature.properties){\n        \tout.push(key + \": \"+feature.properties[key]);\n        }\n        \n        layer.on('click', function(e){\n    L.rrose({ autoPan: false })\n      .setContent(out.join(\"<br/>\"))\n      .setLatLng(e.latlng)\n      .openOn(m);\n  });\n    }\n}\nfunction style(doc) {\n\t\tvar status = doc.properties.FacilityStatus.slice(0,doc.properties.FacilityStatus.indexOf(\":\"));\n\t\tout = {opacity:0.9};\n        switch (status) {\n            case 'Existing':\n            \t//\n            \tbreak;\n            case 'Under construction':\n            \tout.dashArray = \"4, 10\";\n\n            \tbreak;\n            case 'In design':\n            \tout.dashArray = \"4,15\";\n\n            \tbreak;\n            case 'Planned':\n            \tout.dashArray = \"3, 20\"\n            \tbreak;\n        }\n        var facT = doc.properties.FacilityType\n\t\tvar pn = facT.indexOf(\"(\")\n\t\tif( pn>0 ){\n\t\t\t\tfacT = facT.slice(0,pn)\n\t\t}\n\t\tswitch (facT.trim()) {\n\t\t\tcase 'Bike lane':\n\t\t\t\tout.color = \"#E41A1C\";\n\t\t\t\tbreak;\n\t\t\tcase \"Bicycle/Pedestrian priority roadway\":\n\t\t\t\tout.color =\"#377EB8\";\n\t\t\t\tbreak;\n\t\t\tcase \"Cycle track\":\n\t\t\t\tout.color =\"#4DAF4A\";\n\t\t\t\tbreak;\n\t\t\tcase \"Marked shared lane\":\n\t\t\t\tout.color =\"#984EA3\";\n\t\t\t\tbreak;\n\t\t\tcase \"Shared use path\":\n\t\t\t\tout.color =\"#FF7F00\";\n\t\t\t\tbreak;\n\t\t\tcase \"Sign-posted on-road bike route\":\n\t\t\t\tout.color =\"#FFFF33\";\n\t\t\t\tbreak;\n\t\t\tcase \"On-Road - To Be Determined\":\n\t\t\t\tout.color =\"#A65628\";\n\t\t\t\tbreak;\n\t\t\tcase \"Paved bike shoulder\":\n\t\t\t\tout.color =\"#F781BF\";\n\t\t\t\tbreak;\n\t\t\tcase \"Hybrid\":\n\t\t\t\tout.color =\"#999999\";\n\t\t\t\tbreak;\n\t\t}\n        return out;\n    }\nvar db;\nPouch(\"/bikez\",function(err,d){\n\tif(!err){\t\n\t\tdb=d;\n\t\tdb.put({\"language\":\"javascript\",\"spatial\":{\"all\":\"function(doc){if(doc && doc.geometry){emit(doc.geometry,doc)}}\"},\"_id\":\"_design/bike2\"},function(){});\n\t\t$.get(\"bikes.json\",function(d){\n\t\t\td.features.forEach(function(v){\n\t\t\t\tv._id = v.id;\n\t\t\t\tdelete v.id;\n\t\t\t\tdb.put(v,function(){});\n\t\t\t});\n\t\t\tm.on(\"moveend\",updateMap);\n            updateMap();\n\t\t},\"json\");\n\t}\n});\nm.addHash();\nfunction updateMap(){\n    db.spatial(\"bike2/all\",{\"start_range\":[m.getBounds().getSouthWest().lng,m.getBounds().getSouthWest().lat],\"end_range\":[m.getBounds().getNorthEast().lng,m.getBounds().getNorthEast().lat]},function(err,data){\n        m.removeLayer(docs);\n        docs.clearLayers();\n        m.removeLayer(boxes);\n        boxes.clearLayers();\n        \n    \t\t\tdata.rows.forEach(function(v){\n\t\t\t\t\tdocs.addData(v.value);\n\t\t\t\t\tif(v.key.length>1){\n           var bounds= [[v.key[1][0],v.key[0][0]],[v.key[1][1],v.key[0][1]]];\n    \t\t\t\n\t\t\n\t\t\t\t\t\n\t\t\t\t\tvar recto = L.rectangle(bounds,{fill:false}).bindPopup(v.key.toString())\n\t\t\t\t\t\n\t\t\t\t\tboxes.addLayer(recto);\n\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tdocs.addTo(m);\n\t\t\t\t\tboxes.addTo(m);\n\t\t\t\t\n\t\t\t\t});\n}"]],"start1":0,"start2":0,"length1":0,"length2":3597}]],"length":3597,"saved":false}
{"ts":1360341481696,"patch":[[{"diffs":[[0,"bike"],[-1,"z"],[1,"boxes"],[0,"\",fu"]],"start1":2444,"start2":2444,"length1":9,"length2":13}]],"length":3601,"saved":false}
{"ts":1360341647004,"patch":[[{"diffs":[[0,";\nm."],[-1,"addH"],[1,"h"],[0,"ash("]],"start1":2859,"start2":2859,"length1":12,"length2":9}]],"length":3598,"saved":false}
